<!DOCTYPE html>
<html>
<head>
  <title>Edit Job</title>
</head>
<body>

<h2>Edit Job</h2>

<form id="editJobForm">

  <label>College</label><br />
  <select id="collegeId" required></select>
  <br /><br />

  <label>Title</label><br />
  <input type="text" id="title" required />
  <br /><br />

  <label>Description</label><br />
  <textarea id="description" required></textarea>
  <br /><br />

  <label>Salary</label><br />
  <input type="number" id="salary" required />
  <br /><br />

  <label>Deadline</label><br />
  <input type="date" id="deadline" required />
  <br /><br />

  <h4>Eligibility</h4>

  <label>Min CGPA</label><br />
  <input type="number" step="0.1" id="minCGPA" required />
  <br /><br />

  <label>Allowed Branches (comma separated)</label><br />
  <input type="text" id="branches" required />
  <br /><br />

  <label>Graduation Year</label><br />
  <input type="number" id="gradYear" required />
  <br /><br />

  <button type="submit">Update Job</button>

</form>

<p id="msg"></p>
<a href="/company/jobs">Back</a>

<script>
const jobId = "<%= jobId %>";
const collegeSelect = document.getElementById("collegeId");

// Load colleges dropdown
async function loadColleges() {
  const res = await fetch("/api/colleges/public");
  const data = await res.json();

  collegeSelect.innerHTML = `<option value="">Select College</option>`;

  data.colleges.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c._id;
    opt.textContent = c.name;
    collegeSelect.appendChild(opt);
  });
}

// Load existing job
async function loadJob() {
  const res = await fetch(`/api/companies/jobs/${jobId}`, {
    credentials: "include"
  });
  const data = await res.json();
  const job = data.job;


  document.getElementById("title").value = job.title;
  document.getElementById("description").value = job.description;
  document.getElementById("salary").value = job.salary;
  document.getElementById("deadline").value = job.deadline.split("T")[0];

  document.getElementById("minCGPA").value = job.eligibility.minCGPA;
  document.getElementById("branches").value = job.eligibility.allowedBranches.join(",");
  document.getElementById("gradYear").value = job.eligibility.graduationYear;

  // Select college
  collegeSelect.value = job.collegeId;
}

// Submit update
document.getElementById("editJobForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const payload = {
    collegeId: collegeSelect.value,
    title: title.value,
    description: description.value,
    salary: salary.value,
    deadline: deadline.value,
    eligibility: {
      minCGPA: minCGPA.value,
      allowedBranches: branches.value.split(",").map(b => b.trim()),
      graduationYear: gradYear.value
    }
  };

  const res = await fetch(`/api/companies/jobs/${jobId}/edit`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  document.getElementById("msg").innerText = data.message;

  if (data.success) {
    alert("Job Updated");
    window.location.href = "/company/jobs";
  }
});

loadColleges().then(loadJob);
</script>

</body>
</html>
